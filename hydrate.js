function Resurrect(e){this.table=null;this.prefix="#";this.cleanup=false;this.revive=true;for(var t in e){if(e.hasOwnProperty(t)){this[t]=e[t]}}this.refcode=this.prefix+"id";this.origcode=this.prefix+"original";this.buildcode=this.prefix+".";this.valuecode=this.prefix+"v"}Resurrect.GLOBAL=(0,eval)("this");Resurrect.prototype.Error=function(t){this.message=t||"";this.stack=(new Error).stack};Resurrect.prototype.Error.prototype=Object.create(Error.prototype);Resurrect.prototype.Error.prototype.name="ResurrectError";Resurrect.NamespaceResolver=function(e){this.scope=e};Resurrect.NamespaceResolver.prototype.getPrototype=function(e){var t=this.scope[e];if(t){return t.prototype}else{throw new Resurrect.prototype.Error("Unknown constructor: "+e)}};Resurrect.NamespaceResolver.prototype.getName=function(e){var t=e.constructor.name;if(t==null){var n=/^\s*function\s*([A-Za-z0-9_$]*)/;t=n.exec(e.constructor)[1]}if(t===""){var r="Can't serialize objects with anonymous constructors.";throw new Resurrect.prototype.Error(r)}else if(t==="Object"||t==="Array"){return null}else{return t}};Resurrect.prototype.resolver=new Resurrect.NamespaceResolver(Resurrect.GLOBAL);Resurrect.Node=function(e){var t=document.createElement("div");t.innerHTML=e;return t.firstChild};Resurrect.is=function(e){var t="[object "+e+"]";return function(e){return Object.prototype.toString.call(e)===t}};Resurrect.isArray=Resurrect.is("Array");Resurrect.isString=Resurrect.is("String");Resurrect.isBoolean=Resurrect.is("Boolean");Resurrect.isNumber=Resurrect.is("Number");Resurrect.isFunction=Resurrect.is("Function");Resurrect.isDate=Resurrect.is("Date");Resurrect.isRegExp=Resurrect.is("RegExp");Resurrect.isObject=Resurrect.is("Object");Resurrect.isAtom=function(e){return!Resurrect.isObject(e)&&!Resurrect.isArray(e)};Resurrect.prototype.ref=function(e){var t={};if(e===undefined){t[this.prefix]=-1}else{t[this.prefix]=e[this.refcode]}return t};Resurrect.prototype.deref=function(e){return this.table[e[this.prefix]]};Resurrect.prototype.tag=function(e){if(this.revive){var t=this.resolver.getName(e);if(t){var n=Object.getPrototypeOf(e);if(this.resolver.getPrototype(t)!==n){throw new this.Error("Constructor mismatch!")}else{e[this.prefix]=t}}}e[this.refcode]=this.table.length;this.table.push(e);return e[this.refcode]};Resurrect.prototype.builder=function(e,t){var n={};n[this.buildcode]=e;n[this.valuecode]=t;return n};Resurrect.prototype.build=function(e){var t=e[this.buildcode].split(/\./).reduce(function(e,t){return e[t]},Resurrect.GLOBAL);var n=[null].concat(e[this.valuecode]);var r=t.bind.apply(t,n);return new r};Resurrect.prototype.decode=function(e){if(this.prefix in e){return this.deref(e)}else if(this.buildcode in e){return this.build(e)}else{throw new this.Error("Unknown encoding.")}};Resurrect.prototype.isTagged=function(e){return this.refcode in e&&e[this.refcode]!=null};Resurrect.prototype.visit=function(e,t){if(Resurrect.isAtom(e)){return t(e)}else if(!this.isTagged(e)){var n=null;if(Resurrect.isArray(e)){n=[];e[this.refcode]=this.tag(n);for(var r=0;r<e.length;r++){n.push(this.visit(e[r],t))}}else{n=Object.create(Object.getPrototypeOf(e));e[this.refcode]=this.tag(n);for(var i in e){if(e.hasOwnProperty(i)){n[i]=this.visit(e[i],t)}}}n[this.origcode]=e;return this.ref(n)}else{return this.ref(e)}};Resurrect.prototype.handleAtom=function(e){var t=Resurrect.GLOBAL.Node||function(){};if(Resurrect.isFunction(e)){throw new this.Error("Can't serialize functions.")}else if(e instanceof t){var n=new XMLSerializer;return this.builder("Resurrect.Node",[n.serializeToString(e)])}else if(Resurrect.isDate(e)){return this.builder("Date",[e.toISOString()])}else if(Resurrect.isRegExp(e)){var r=e.toString().match(/\/(.+)\/([gimy]*)/).slice(1);return this.builder("RegExp",r)}else if(e===undefined){return this.ref(undefined)}else{return e}};Resurrect.prototype.stringify=function(e){if(Resurrect.isAtom(e)){return JSON.stringify(this.handleAtom(e))}else{this.table=[];this.visit(e,this.handleAtom.bind(this));for(var t=0;t<this.table.length;t++){if(this.cleanup){delete this.table[t][this.origcode][this.refcode]}else{this.table[t][this.origcode][this.refcode]=null}delete this.table[t][this.refcode];delete this.table[t][this.origcode]}var n=this.table;this.table=null;return JSON.stringify(n)}};Resurrect.prototype.fixPrototype=function(e){if(this.prefix in e){var t=e[this.prefix];var n=this.resolver.getPrototype(t);if("__proto__"in e){e.__proto__=n;if(this.cleanup){delete e[this.prefix]}return e}else{var r=Object.create(n);for(var i in e){if(e.hasOwnProperty(i)&&i!==this.prefix){r[i]=e[i]}}return r}}else{return e}};Resurrect.prototype.resurrect=function(e){var t=null;var n=JSON.parse(e);if(Resurrect.isArray(n)){this.table=n;if(this.revive){for(var r=0;r<this.table.length;r++){this.table[r]=this.fixPrototype(this.table[r])}}for(r=0;r<this.table.length;r++){var i=this.table[r];for(var s in i){if(i.hasOwnProperty(s)){if(!Resurrect.isAtom(i[s])){i[s]=this.decode(i[s])}}}}t=this.table[0]}else if(Resurrect.isObject(n)){this.table=[];t=this.decode(n)}else{t=n}this.table=null;return t}